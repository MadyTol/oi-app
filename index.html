<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Oi ‚Äî –µ–¥–∏–Ω–æ–¥—Ä—É–≥</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f3f6f8;
      --card:#fff;
      --primary:#1d7aff;
      --muted:#9aa4b2;
      --radius:14px;
      --gap:16px;
      font-family: Inter, Arial, sans-serif;
    }
    body{
      margin:0;
      background:var(--bg);
      display:flex;
      justify-content:center;
      padding:40px 16px;
    }
    .container{
      width:100%;
      max-width:760px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:32px;
      box-shadow:0 8px 30px rgba(15,23,42,0.06);
    }
    h1{font-size:32px;margin:0 0 10px 0}
    p.lead{color:var(--muted);margin:0 0 20px 0}

    /* City grid */
    .cities{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:20px}
    .cityCard{
      border-radius:12px;padding:18px;background:#fff;border:1px solid rgba(0,0,0,0.04);
      display:flex;align-items:center;gap:12px;cursor:pointer;justify-content:center;font-weight:600;
      box-shadow:0 6px 18px rgba(15,23,42,0.03);
    }
    .cityCard.selected{outline:3px solid rgba(29,122,255,0.15);box-shadow:0 10px 30px rgba(29,122,255,0.06);}

    /* actions */
    .actions{display:flex;gap:12px;margin-bottom:28px}
    .btn{padding:12px 18px;border-radius:12px;border:none;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;box-shadow:0 8px 20px rgba(29,122,255,0.14)}
    .btn.ghost{background:#fff;border:1px solid rgba(0,0,0,0.06)}

    /* registration */
    .reg{margin-top:10px}
    .input{width:100%;padding:12px;border-radius:10px;border:1px solid #e4e8ef;margin-bottom:12px}
    .categories{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .catBtn{padding:8px 12px;border-radius:20px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
    .catBtn.active{background:rgba(29,122,255,0.08);border-color:rgba(29,122,255,0.18)}

    /* hobby cards grid */
    #hobbyCards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .hobbyCard{
      background:#fff;border-radius:12px;padding:14px;text-align:center;cursor:pointer;
      border:1px solid rgba(0,0,0,0.04);box-shadow:0 8px 20px rgba(15,23,42,0.03);
      user-select:none;font-weight:600;
    }
    .hobbyCard.selected{background:linear-gradient(90deg,var(--primary),#63a7ff);color:#fff;border:none;box-shadow:0 14px 30px rgba(29,122,255,0.12)}

    /* modal custom hobby */
    #customHobbyModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:9999}
    #customHobbyModal .modalBox{background:#fff;padding:18px;border-radius:12px;width:90%;max-width:380px;text-align:center}
    .flexRow{display:flex;gap:8px;justify-content:center;align-items:center}

    .small{font-size:13px;color:#7b8791}
    .footer{margin-top:18px;display:flex;justify-content:space-between;gap:12px}

    @media (max-width:480px){
      #hobbyCards{grid-template-columns:repeat(2,1fr)}
      .cities{grid-template-columns:repeat(1,1fr)}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</h1>
      <p class="lead">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å. –ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å.</p>

      <input id="citySearch" class="input" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä –ë–∏—à–∫–µ–∫)">

      <div class="cities" id="cities">
        <!-- –≥–æ—Ä–æ–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
      </div>

      <div class="actions">
        <button id="sendToBot" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É</button>
        <button id="saveLocal" class="btn ghost">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
      </div>

      <hr style="border:none;height:1px;background:#f0f3f5;margin:18px 0">

      <div id="registration" class="reg">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <p class="small">–£–∫–∞–∂–∏—Ç–µ –∏–º—è, –≤–æ–∑—Ä–∞—Å—Ç –∏ —Ö–æ–±–±–∏</p>

        <input id="inpName" class="input" placeholder="–í–∞—à–µ –∏–º—è">
        <input id="inpAge" class="input" placeholder="–í–æ–∑—Ä–∞—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä 28)" inputmode="numeric">

        <div style="margin-top:8px">
          <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ö–æ–±–±–∏</div>
          <div class="categories" id="categories">
            <!-- –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
          </div>
        </div>

        <div id="hobbyCards" style="margin-top:6px">
          <!-- —Ö–æ–±–±–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
        </div>

        <div style="display:flex;gap:12px;margin-top:18px">
          <button id="backBtn" class="btn ghost">–ù–∞–∑–∞–¥</button>
          <button id="submitReg" class="btn primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>

        <p id="regMsg" class="small" style="margin-top:12px;color:#2f8a2f;display:none"></p>
      </div>
    </div>
  </div>

  <!-- Modal for custom hobby -->
  <div id="customHobbyModal">
    <div class="modalBox">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—ë —Ö–æ–±–±–∏</h3>
      <input id="customHobbyInput" class="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ô–æ–≥–∞">
      <div class="footer">
        <button id="cancelCustomHobby" class="btn ghost">–û—Ç–º–µ–Ω–∞</button>
        <button id="saveCustomHobby" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

<script>
(function(){
  /* ====== Data ====== */
  const CITIES = [
    {id:'bishkek', title:'–ë–∏—à–∫–µ–∫'},
    {id:'almaty', title:'–ê–ª–º–∞—Ç—ã'},
    {id:'astana', title:'–ê—Å—Ç–∞–Ω–∞'},
    {id:'moscow', title:'–ú–æ—Å–∫–≤–∞'},
    {id:'tashkent', title:'–¢–∞—à–∫–µ–Ω—Ç'}
  ];

  const HOBBY_CATEGORIES = {
    "–°–ø–æ—Ä—Ç": [
      {id:'football', title:'–§—É—Ç–±–æ–ª'},
      {id:'swimming', title:'–ü–ª–∞–≤–∞–Ω–∏–µ'},
      {id:'tennis', title:'–ù–∞—Å—Ç–æ–ª—å–Ω—ã–π —Ç–µ–Ω–Ω–∏—Å'},
      {id:'basketball', title:'–ë–∞—Å–∫–µ—Ç–±–æ–ª'},
      {id:'volleyball', title:'–í–æ–ª–µ–π–±–æ–ª'},
      {id:'running', title:'–ë–µ–≥'},
      {id:'boxing', title:'–ë–æ–∫—Å'},
      {id:'crossfit', title:'–ö—Ä–æ—Å—Å—Ñ–∏—Ç'},
      {id:'cycling', title:'–í–µ–ª–æ—Å–∏–ø–µ–¥'}
    ],
    "–ò—Å–∫—É—Å—Å—Ç–≤–æ": [
      {id:'music', title:'–ú—É–∑—ã–∫–∞'},
      {id:'dance', title:'–¢–∞–Ω—Ü—ã'},
      {id:'painting', title:'–†–∏—Å–æ–≤–∞–Ω–∏–µ'},
      {id:'theatre', title:'–¢–µ–∞—Ç—Ä'}
    ],
    "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": [
      {id:'coding', title:'–ö–æ–¥–∏–Ω–≥'},
      {id:'robotics', title:'–†–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∞'},
      {id:'gaming', title:'–ì–µ–π–º–¥–µ–≤'}
    ],
    "–û–±—â–µ–Ω–∏–µ": [
      {id:'coffee', title:'–ö–æ—Ñ–µ/–≤—Å—Ç—Ä–µ—á–∏'},
      {id:'boardgames', title:'–ù–∞—Å—Ç–æ–ª–∫–∏'},
      {id:'travel', title:'–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'}
    ]
  };

  /* ====== Elements ====== */
  const citiesWrap = document.getElementById('cities');
  const citySearch = document.getElementById('citySearch');
  const sendToBot = document.getElementById('sendToBot');
  const saveLocal = document.getElementById('saveLocal');

  const categoriesWrap = document.getElementById('categories');
  const hobbyCardsWrap = document.getElementById('hobbyCards');

  const inpName = document.getElementById('inpName');
  const inpAge = document.getElementById('inpAge');
  const submitReg = document.getElementById('submitReg');
  const regMsg = document.getElementById('regMsg');

  const customModal = document.getElementById('customHobbyModal');
  const customInput = document.getElementById('customHobbyInput');
  const saveCustomHobby = document.getElementById('saveCustomHobby');
  const cancelCustomHobby = document.getElementById('cancelCustomHobby');

  /* ====== State ====== */
  let selectedCity = null;
  let selectedCategory = null;

  /* ====== Helpers ====== */
  function clearChildren(el){ while(el.firstChild) el.removeChild(el.firstChild); }

  /* ====== Render cities ====== */
  function renderCities(list){
    clearChildren(citiesWrap);
    list.forEach(c=>{
      const d = document.createElement('div');
      d.className = 'cityCard';
      d.dataset.id = c.id;
      d.innerHTML = `<span style="font-size:18px;margin-right:8px">${flagEmoji(c.id)}</span>${c.title}`;
      d.onclick = () => {
        document.querySelectorAll('.cityCard').forEach(x=>x.classList.remove('selected'));
        d.classList.add('selected');
        selectedCity = c;
      };
      citiesWrap.appendChild(d);
    });
  }

  function flagEmoji(id){
    if(id==='bishkek') return 'üá∞üá¨';
    if(id==='almaty' || id==='astana') return 'üá∞üáø';
    if(id==='moscow') return 'üá∑üá∫';
    if(id==='tashkent') return 'üá∫üáø';
    return 'üìç';
  }

  citySearch.addEventListener('input', ()=>{
    const q = citySearch.value.trim().toLowerCase();
    const filtered = CITIES.filter(ci => ci.title.toLowerCase().includes(q));
    renderCities(filtered.length?filtered:CITIES);
  });

  renderCities(CITIES);

  /* ====== Render categories and hobby cards ====== */
  function renderCategories(){
    clearChildren(categoriesWrap);
    Object.keys(HOBBY_CATEGORIES).forEach(cat=>{
      const b = document.createElement('button');
      b.className = 'catBtn';
      b.textContent = cat;
      b.onclick = () => {
        document.querySelectorAll('.catBtn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        selectedCategory = cat;
        renderHobbiesFor(cat);
      };
      categoriesWrap.appendChild(b);
    });
    // default select first
    const first = categoriesWrap.querySelector('.catBtn');
    if(first) { first.click(); }
  }

  function renderHobbiesFor(category){
    clearChildren(hobbyCardsWrap);
    const list = HOBBY_CATEGORIES[category] || [];
    list.forEach(h=>{
      const card = document.createElement('div');
      card.className = 'hobbyCard';
      card.dataset.id = h.id;
      card.innerText = h.title;
      card.onclick = () => card.classList.toggle('selected');
      hobbyCardsWrap.appendChild(card);
    });

    // Add "Add custom hobby" tile as last
    const custom = document.createElement('div');
    custom.className = 'hobbyCard';
    custom.id = 'addCustomHobby';
    custom.innerHTML = '‚ûï –î—Ä—É–≥–æ–µ';
    custom.onclick = () => {
      customInput.value = '';
      customModal.style.display = 'flex';
      customInput.focus();
    };
    hobbyCardsWrap.appendChild(custom);
  }

  renderCategories();

  /* ====== Custom hobby modal handlers ====== */
  cancelCustomHobby.onclick = () => customModal.style.display = 'none';
  saveCustomHobby.onclick = () => {
    const v = customInput.value.trim();
    if(!v) return;
    // create new hobby card and select it
    const id = 'custom_' + v.toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
    const card = document.createElement('div');
    card.className = 'hobbyCard selected';
    card.dataset.id = id;
    card.innerText = v;
    card.onclick = () => card.classList.toggle('selected');
    // insert before the custom tile (which is last)
    const customTile = document.getElementById('addCustomHobby');
    hobbyCardsWrap.insertBefore(card, customTile);
    customModal.style.display = 'none';
  };

  /* ====== Save / Send handlers ====== */
  function collectRegistration(){
    const name = inpName.value.trim();
    const age = inpAge.value.trim();
    const city = selectedCity ? selectedCity.title : null;
    const hobbies = Array.from(document.querySelectorAll('.hobbyCard.selected')).map(el=>el.innerText.trim());
    return { name, age, city, hobbies };
  }

  saveLocal.onclick = ()=>{
    const data = collectRegistration();
    localStorage.setItem('oi_reg', JSON.stringify(data));
    regMsg.style.display='block';
    regMsg.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ ‚úÖ';
    setTimeout(()=> regMsg.style.display='none', 3500);
  };

  submitReg.onclick = ()=>{
    const data = collectRegistration();
    if(!data.city){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥'); return; }
    if(!data.name){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
    if(!data.hobbies.length){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ö–æ–±–±–∏'); return; }

    // save locally
    localStorage.setItem('oi_reg', JSON.stringify(data));

    // try send to Telegram WebApp if available
    try{
      const tg = window.Telegram.WebApp;
      if(tg){
        tg.sendData(JSON.stringify({ type:'registration', payload:data }));
        regMsg.style.display='block';
        regMsg.style.color='#2f8a2f';
        regMsg.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É ‚úÖ';
      } else {
        regMsg.style.display='block';
        regMsg.style.color='#2f8a2f';
        regMsg.textContent = '–õ–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–Ω–µ—Ç Telegram) ‚úÖ';
      }
    }catch(e){
      regMsg.style.display='block';
      regMsg.style.color='crimson';
      regMsg.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + e.message;
    }
    setTimeout(()=> regMsg.style.display='none', 4000);
  };

  sendToBot.onclick = ()=>{
    const data = collectRegistration();
    if(!data.city){
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.');
      return;
    }
    try{
      const tg = window.Telegram.WebApp;
      if(tg){
        tg.sendData(JSON.stringify({ type:'city_selected', payload:{city: data.city}}));
        alert('–î–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É ‚úÖ');
      } else {
        alert('Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω ‚Äî –æ—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É.');
      }
    }catch(e){
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + e.message);
    }
  };

  /* ====== Init from localStorage if present ====== */
  (function initFromLocal(){
    const raw = localStorage.getItem('oi_reg');
    if(!raw) return;
    try{
      const parsed = JSON.parse(raw);
      if(parsed.city){
        const cityEl = Array.from(document.querySelectorAll('.cityCard')).find(x=>x.innerText.includes(parsed.city));
        if(cityEl) { cityEl.click(); }
      }
      if(parsed.name) inpName.value = parsed.name;
      if(parsed.age) inpAge.value = parsed.age;

      // select hobbies by titles (if match)
      if(parsed.hobbies && parsed.hobbies.length){
        parsed.hobbies.forEach(h => {
          // try to find matching hobby card by text
          const card = Array.from(document.querySelectorAll('.hobbyCard')).find(c => c.innerText.trim().toLowerCase() === h.trim().toLowerCase());
          if(card) card.classList.add('selected');
          else {
            // create custom selected card
            const id = 'custom_' + h.toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
            const newCard = document.createElement('div');
            newCard.className = 'hobbyCard selected';
            newCard.dataset.id = id;
            newCard.innerText = h;
            newCard.onclick = () => newCard.classList.toggle('selected');
            const customTile = document.getElementById('addCustomHobby');
            if(customTile) hobbyCardsWrap.insertBefore(newCard, customTile);
            else hobbyCardsWrap.appendChild(newCard);
          }
        });
      }
    }catch(e){ /* ignore parse errors */ }
  })();

  /* ====== Small UX nicety: close modal with ESC ====== */
  window.addEventListener('keydown', (ev)=>{
    if(ev.key === 'Escape') customModal.style.display = 'none';
  });

})();
</script>
</body>
</html>
