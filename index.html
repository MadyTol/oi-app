<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oi ‚Äî –µ–¥–∏–Ω–æ–¥—Ä—É–≥</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --accent:#1d7aff;
      --muted:#667085;
      --radius:14px;
      --gap:18px;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,Arial,sans-serif;color:#0f1724}
    .wrap{max-width:900px;margin:36px auto;padding:20px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(12,14,20,0.06);padding:28px; text-align:center}
    h1{margin:0 0 8px;font-size:26px;color:#0b1220}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .btn{display:inline-block;background:var(--accent);color:#fff;padding:12px 18px;border-radius:9px;border:none;cursor:pointer;font-weight:600;box-shadow:0 6px 16px rgba(29,122,255,0.18)}
    .btn.ghost{background:transparent;color:var(--accent);box-shadow:none;border:1px solid rgba(29,122,255,0.12)}
    .controls{display:flex;gap:12px;align-items:center;justify-content:center;margin:18px 0 22px;flex-wrap:wrap}
    .search{flex:1;min-width:220px}
    input.search{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6e9ef;background:#fff;box-sizing:border-box}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:var(--gap);margin-top:6px}
    .city{background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,1));padding:14px;border-radius:12px;border:1px solid rgba(12,14,20,0.03);cursor:pointer;display:flex;align-items:center;gap:12px;transition:transform .14s ease, box-shadow .14s ease}
    .city:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(12,14,20,0.06)}
    .city .flag{font-size:28px}
    .city .name{font-weight:600}
    .city.selected{outline:3px solid rgba(29,122,255,0.12);box-shadow:0 16px 40px rgba(29,122,255,0.06)}
    .footer{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:22px;flex-wrap:wrap}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:34px;background:#0b1220;color:#fff;padding:10px 16px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s}
    .toast.show{opacity:1;pointer-events:auto}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:420px){
      .wrap{margin:18px;padding:14px}
      .card{padding:18px}
      .grid{gap:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="start-card">
      <h1>Oi <span style="font-size:18px">üëã</span></h1>
      <p class="lead">–ü–æ–∏—Å–∫ –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤ –ø–æ –≥–æ—Ä–æ–¥–∞–º</p>
      <div style="margin-top:14px">
        <button class="btn" id="open-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
    </div>

    <div class="card" id="select-card" style="display:none; margin-top:18px">
      <h1>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</h1>
      <p class="small">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å. –ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å.</p>

      <div class="controls" style="margin-top:14px">
        <div class="search">
          <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä –ë–∏—à–∫–µ–∫)" />
        </div>
        <div>
          <button id="clear" class="btn ghost">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <div class="grid" id="grid"></div>

      <div class="footer">
        <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É</button>
        <button id="saveBtn" class="btn ghost">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // –¢–µ–ª–µ–≥—Ä–∞–º WebApp
    const tg = window.Telegram?.WebApp || null;
    try{ tg && tg.expand && tg.expand(); }catch(e){}

    // –ì–æ—Ä–æ–¥–∞ (—Ñ–ª–∞–≥ - emoji)
    const CITIES = [
      { id: 'bishkek', name: '–ë–∏—à–∫–µ–∫', flag: 'üá∞üá¨' },
      { id: 'almaty', name: '–ê–ª–º–∞—Ç—ã', flag: 'üá∞üáø' },
      { id: 'astana', name: '–ê—Å—Ç–∞–Ω–∞', flag: 'üá∞üáø' },
      { id: 'moscow', name: '–ú–æ—Å–∫–≤–∞', flag: 'üá∑üá∫' },
      { id: 'tashkent', name: '–¢–∞—à–∫–µ–Ω—Ç', flag: 'üá∫üáø' }
    ];

    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const openBtn = document.getElementById('open-btn');
    const startCard = document.getElementById('start-card');
    const selectCard = document.getElementById('select-card');
    const toast = document.getElementById('toast');
    const sendBtn = document.getElementById('sendBtn');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clear');

    let selected = localStorage.getItem('oi_city') || null;

    function showToast(msg, timeout=2200){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), timeout);
    }

    function renderCities(filter = ''){
      grid.innerHTML = '';
      const q = filter.trim().toLowerCase();
      const visible = CITIES.filter(c => c.name.toLowerCase().includes(q) || c.id.includes(q));
      visible.forEach(city => {
        const node = document.createElement('div');
        node.className = 'city' + (selected === city.id ? ' selected' : '');
        node.dataset.id = city.id;
        node.innerHTML = `<div class="flag">${city.flag}</div><div class="name">${city.name}</div>`;
        node.addEventListener('click', () => {
          selectCity(city.id);
        });
        grid.appendChild(node);
      });
      if(visible.length === 0){
        grid.innerHTML = '<div class="small" style="padding:12px;text-align:center;color:var(--muted)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      }
    }

    function selectCity(id){
      selected = id;
      localStorage.setItem('oi_city', id);
      renderCities(search.value);
      const cityObj = CITIES.find(c=>c.id===id);
      showToast('–í—ã –≤—ã–±—Ä–∞–ª–∏: ' + (cityObj?cityObj.name:id));
    }

    function sendToBot(){
      if(!selected){
        showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥');
        return;
      }
      const cityObj = CITIES.find(c=>c.id===selected);
      const payload = JSON.stringify({ action: 'city_selected', city: selected, name: cityObj?.name || selected });
      if(tg && tg.sendData){
        try {
          tg.sendData(payload);
          showToast('–ì–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É: ' + (cityObj?.name || selected));
        } catch(e){
          console.error(e);
          showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –±–æ—Ç—É');
        }
      } else {
        // fallback: –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å
        showToast('–î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã (–ª–æ–∫–∞–ª—å–Ω–æ): ' + (cityObj?.name || selected));
        console.log('Payload to bot:', payload);
      }
    }

    // UI handlers
    openBtn.addEventListener('click', ()=>{
      startCard.style.display = 'none';
      selectCard.style.display = 'block';
      renderCities();
      if(tg && tg.MainButton) tg.MainButton.hide && tg.MainButton.hide();
    });

    search.addEventListener('input', (e)=> renderCities(e.target.value));
    sendBtn.addEventListener('click', sendToBot);
    saveBtn.addEventListener('click', ()=>{
      if(!selected) return showToast('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –ø—Ä–µ–∂–¥–µ —á–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
      showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
    });
    clearBtn.addEventListener('click', ()=>{
      search.value = '';
      renderCities('');
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    renderCities();

    // –ï—Å–ª–∏ —É–∂–µ –±—ã–ª –≤—ã–±–æ—Ä ‚Äî —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å
    if(selected){
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
      startCard.style.display = 'none';
      selectCard.style.display = 'block';
      renderCities();
    }

    // Accessibility: Enter on search triggers filter (already handled)
    // End of script
  </script>
</body>
</html>
